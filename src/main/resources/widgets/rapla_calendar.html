<div id="$id" style="width: 100%; height: 100%" class="z-depth-3">
    <div id="grid_$id" class="grid_$id" style="width: 100%; height: 100%">
    </div>
    <div id="back_grid_$id" class="grid_$id back_grid_$id" style="width: 100%; height: 100%">
    </div>
</div>

<style>
    .grid_$id{
        display: grid;
        border-style: solid;
        border-width: 2px;
        border-radius: 7px;
    }
    .back_grid_$id{
        position: relative;
        top: -100%;
        z-index: -1;
        border-radius: 7px;
    }


    .greyContainer{
        background-color: #36393E !important;
    }

    
    .calendarCase{
        height: calc(100% - 6px);
        width: calc(100% - 6px);
        border: darkslategray dashed 1px;
        margin: 3px;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        background: rgba(50, 205, 50, 0.85);
        ;
    }



    .activeDay{
        border: black solid 2px;
    }

    .backCellEnd{
        border-bottom: white solid 2px;
        border-left: lightgray solid 1px;
        background: #E6EBF4;
    }
    .backCell{
        border-bottom: lightgray solid 2px;
        border-left: lightgray solid 1px;
        background: #E6EBF4;
    }
    .backCellLeft{
        border-right: white solid 2px;
        border-left: none;
        background: #E6EBF4;

    }

    .day{
        border-style: solid;
        border-width: 1px;
        border-color: rgba(127,126,128,0.44);
    }
    .dateContainer{
        height: 100%;
        display: flex;
        justify-content: center;
        align-content: center;
        flex-direction: column;
        font-weight: bold;
        border-left: white solid 2px ;

    }
    .noLeft{
        border-left: none;
    }

    .calendarCase .row{
        margin-bottom: 4px;
    }

    .custom-divider{
        height: 1px;
        overflow: hidden;
        border-top: darkslategray dashed 1px;
        padding: 0 !important;
    }

    .activeDay .custom-divider{
        border-top: darkslategray solid 2px;
    }

</style>

<script>
    $.get("/api/getWidgetConf?id=$id", (config) => {
        let param = config.param;
        console.log(config);
        let calendars = param.calendars;
        let toRemoveStart = param.day_start * 60 / 15 - 1;
        let toRemoveEnd = (24 - param.day_end) * 60 / 15 +1;
        let daylength = 96 - toRemoveEnd - toRemoveStart;
        let nbrDay = param.weekend ? 7 : 5;
        $(".grid_$id").css( "grid-template-rows", "7% repeat("+daylength+",1fr)");
        $(".grid_$id").css( "grid-template-columns", "7% repeat("+nbrDay+",1fr)");
        let html = "";
        let now = new Date(Date.now());
        let monday = getMonday(now);
        let sunday = new Date();
        sunday.setDate(monday.getDate() + 6);
        sunday.setHours(23);
        sunday.setMinutes(59);


        createBackGrid(daylength,param.day_start, nbrDay, monday);


        let list = [];
        calendars.forEach(function (event) {
            let start = new Date(event.dtstart * 1000);
            if(start > monday && start < sunday)
                list.push(event);



        });

        list.sort(compareDate);
        list.forEach(function (ev) {
            let start = new Date(ev.dtstart * 1000);
            let end = new Date(ev.dtend * 1000);
            let startMin = start.getMinutes() + start.getHours() * 60;
            let endMin = end.getMinutes() + end.getHours() * 60;
            let startPos = startMin / 15 - toRemoveStart + 1;
            let endPos = endMin /15 - toRemoveStart + 1;
            let dayPos = start.getDay() + 1 ;
            let text = "";
            let summary = ev.summary.replace(/\[(.*)]+/, "");
            text += summary + "<br/>";
            let resource = ev.summary.match(/\[(.*)]+/);
            if(resource)
                resource = resource[1] + "<br/>";

            let places = ev.location;
            if(places)
                text += places + "<br/>";
            if(dayPos === 0){
                dayPos = 8;
            }
            let options = {hour: "numeric", minute: "numeric"};
            html += "<div class='"+((now > start && now < end) ? "activeDay" : "") + " calendarCase' style='grid-area: "+startPos+" / "+dayPos+" / "+ endPos +"/ "+dayPos+";text-align: center'>" +
                "<div class='row'>" +
                "<div class='col s12'>" +
                start.toLocaleString("fr-FR",options) +  " - " + end.toLocaleTimeString("fr-FR", options)+
                "</div>" +
                "</div>"+
                "<div class='row'><div class='col s12 custom-divider'></div></div>"+
                "<div class='row'>" +
                "<div class='col s12'>" +
                summary +
                "</div>" +
                "</div>"+
                "<div class='row'><div class='col s12 custom-divider' style='border-top-style: dotted'></div></div>"+
                "<div class='row'>" +
                "<div class='col s12'>" +
                resource +
                "</div>" +
                "</div>"+
                "<div class='row'><div class='col s12 custom-divider' style='border-top-style: dotted'></div></div>"+
                "<div class='row'>" +
                "<div class='col s12'>" +
                places +
                "</div>" +
                "</div>"+
                "</div>";
        });


        $('#grid_$id').html(html);
        console.log(param);




        function getMonday(d) {
            d = new Date(d);
            let day = d.getDay();
            let diff = d.getDate() - day + (day === 0 ? -6:1);
            let result  = new Date(d.setDate(diff));
            result.setHours(0);
            result.setMinutes(1);
            console.log(result.toLocaleString("fr-FR"));
            return result;
        }



        function compareDate(a, b){
            let startA = new Date(a.dtstart * 1000);
            let startB = new Date(b.dtstart * 1000);
            if(startA < startB)
                return -1;
            if(startA  > startB)
                return 1;
            return 0;

        }

        function getWeekDay(day, locale)
        {
            let str = day.toLocaleDateString(locale, { weekday: 'long' });
            return  str.charAt(0).toUpperCase() + str.slice(1);

        }

        function getDate(day, locale){
            return day.toLocaleDateString(locale, { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function createBackGrid(nbrRow, startHour, nbrDay, monday){
            let html = "";
            let dateClone = new Date(monday.getTime());

            html += "<div style='grid-area: 1 / 1 / 1 / 1; border-right: white solid 2px' class='backCellEnd noLeft greyContainer'></div>";
            for(let j = 0; j<nbrDay; j++){
                html += "<div style='grid-area: 1 / "+(j+2)+" / 1 / "+(j+2)+";' class='backCellEnd center dateContainer greyContainer white-text "+ (j===0 ? 'noLeft' : '') +"'><p style='margin: 0'>"+ getWeekDay(dateClone, "fr-FR") +"</p><p style='margin: 0'>"+getDate(dateClone, "fr-FR")+"</p></div>";
                dateClone.setDate(dateClone.getDate() + 1);
            };

            let dayOffset = 0;
            for(let row = 2; row<=nbrRow+1 ;row++){
                for(let day = 1; day<= nbrDay+1; day++){
                    if((row-1) % 4 === 0 && row !== nbrRow  + 1 && day !== 1){
                        html += "<div style='grid-area: "+row+" / "+day+" / "+row+" / "+day+";' class='backCellEnd'></div>"


                    }
                    else{
                        if(day === 1 && (row+2) % 4 === 0 ){
                            html += "<div style='grid-area: "+row+" / "+day+" / "+(row+4)+" / "+day+";overflow: hidden; font-size: 18px' class='backCellLeft "+(row+2 === nbrRow ?  "" : "backCellEnd") +" center greyContainer white-text'>"+(startHour + dayOffset)+":00</div>";
                            dayOffset++;
                        }else if( day !==1){
                            html += "<div style='grid-area: "+row+" / "+day+" / "+row+" / "+day+";' class='backCell'></div>"
                        }

                    }


                }
            }
            $("#back_grid_$id").html(html);
        }
    });

</script>
